# Bitnami Kafka single-broker (KRaft)
FROM bitnamilegacy/kafka:latest

USER root

# Install kcat (kafkacat) for the smoke test
RUN install_packages kafkacat

# Copy scripts to a writable location for user 1001
COPY --chmod=755 kafka-files/create-topics.sh /opt/bitnami/create-topics.sh
COPY --chmod=755 kafka-files/smoke-test.sh   /opt/bitnami/smoke-test.sh
COPY --chmod=755 kafka-files/app-start.sh    /opt/bitnami/app-start.sh

# Expose ports: internal 9092, external 9094 (will be mapped to host 29092)
EXPOSE 9092 9094

# Back to non-root (Bitnami default)
USER 1001

# Wrapper entrypoint: start Kafka, wait, create topics, run smoke
ENTRYPOINT ["/opt/bitnami/app-start.sh"]
# Save as prometheus-recording.rules.yml
groups:
- name: postgres_recording
  interval: 30s
  rules:
  # WAL throughput (bytes per second)
  - record: pg:wal_bytes:rate_per_s
    expr: rate(pg_wal_stats_wal_bytes[5m])

  # Replication lag in seconds (standbys)
  - record: pg:replication_lag_seconds
    expr: max(replay_lag_seconds)

  # Replication lag in bytes (primary perspective per replica)
  - record: pg:replication_lag_bytes
    expr: max(bytes_lag) by (application_name)

  # BRIN hit ratio over time by index (avoid divide-by-zero)
  - record: pg:brin_hit_ratio
    expr: |
      sum by (index_name, schemaname, table_name)(rate(idx_blks_hit[10m]))
      / clamp_min(
          sum by (index_name, schemaname, table_name)(rate(idx_blks_hit[10m]) + rate(idx_blks_read[10m])),
          1
        )
